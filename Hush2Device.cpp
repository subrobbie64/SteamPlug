#include "Hush2Device.h"
#include "ButtplugConfig.h"
#include <algorithm>

HushDevice::HushDevice(ButtplugConfig& config)
	: ButtplugDevice(config), _buttplugService(), _rxCharac(), _txCharac(), _status(BP_DISCONNECTED), _deviceId(), _deviceName() {

	_definition = &HUSH_DEVICE[config.getHushType()];

	_vibration = 0;
	_batteryLevel = 0;

	_connectRetryAt = 0;
	_connectedEvent = System::CreateEventFlag();
	System::CreateSema(&_runningCommand, 1);

	__hook(&CwclGattClient::OnConnect, &_wclGattClient, &HushDevice::wclGattClientConnect);
	__hook(&CwclGattClient::OnDisconnect, &_wclGattClient, &HushDevice::wclGattClientDisconnect);
	__hook(&CwclGattClient::OnCharacteristicChanged, &_wclGattClient, &HushDevice::wclGattClientCharacteristicChanged);

	_wclBluetoothManager.SetMessageProcessing(mpAsync);
	int res = _wclBluetoothManager.Open();
	if (res != WCL_E_SUCCESS)
		error("Error opening Bluetooth manager: 0x%X", res);

	_wclGattClient.Address = config.getHushAddress();
	_wclGattClient.ConnectOnRead = true;
	_wclGattClient.ForceNotifications = false;
}

HushDevice::~HushDevice() {
	__unhook(&CwclGattClient::OnConnect, &_wclGattClient, &HushDevice::wclGattClientConnect);
	__unhook(&CwclGattClient::OnDisconnect, &_wclGattClient, &HushDevice::wclGattClientDisconnect);
	__unhook(&CwclGattClient::OnCharacteristicChanged, &_wclGattClient, &HushDevice::wclGattClientCharacteristicChanged);

	System::DestroyEventFlag(_connectedEvent);
	System::DestroySema(&_runningCommand);
}

void HushDevice::connect() {
	if (_connectRetryAt > System::GetMicros()) {
		debug("connect(): Waiting for retry delay\n");
		return;
	}

	_connectRetryAt = System::GetMicros() + CONNECT_RETRY_MS * 1000;
	_vibration = 0;

	debug("Trying to connect to Buttplug device...\n");
	CwclBluetoothRadio* Radio;
	int Res = _wclBluetoothManager.GetLeRadio(Radio);
	if (Res != WCL_E_SUCCESS)
		error("Get working radio failed");

	System::ResetEvent(_connectedEvent);
	_status = BP_CONNECTING;
	Res = _wclGattClient.Connect(Radio);
	if (Res != WCL_E_SUCCESS) {
		debug("GATT Connect error: %02X", Res);
		disconnect();
	}
}

void HushDevice::disconnect() {
	_wclGattClient.Disconnect();
	_status = BP_DISCONNECTED;
	System::SetEvent(_connectedEvent);
}

std::string HushDevice::getGapName() {
	std::string deviceName;

	wclGattService genericAccessService;
	if (_wclGattClient.FindService(GENERIC_ACCESS_SERVICE_UUID, genericAccessService) == WCL_E_SUCCESS) {
		wclGattCharacteristic deviceNameCharac;
		if (_wclGattClient.FindCharacteristic(genericAccessService, DEVICE_NAME_CHARAC_UUID, deviceNameCharac) == WCL_E_SUCCESS) {
			unsigned char* nameBuffer;
			unsigned long length;
			if (_wclGattClient.ReadCharacteristicValue(deviceNameCharac, goNone, nameBuffer, length) == WCL_E_SUCCESS) {
				if (nameBuffer) {
					deviceName = std::string((const char*)nameBuffer, length);
					free(nameBuffer);
				}
			}
		}
	}
	return deviceName;
}

void HushDevice::wclGattClientConnect(void* Sender, const int Error) {
	int Res;
	if (Error == WCL_E_SUCCESS) {
		_deviceName = getGapName();
		if ((Res = _wclGattClient.FindService(_definition->serviceId, _buttplugService)) != WCL_E_SUCCESS)
			debug("FindService failed 0x%X!\n", Res);
		else if ((Res = _wclGattClient.FindCharacteristic(_buttplugService, _definition->txCharacteristicId, _txCharac)) != WCL_E_SUCCESS)
			debug("FindCharacteristic (TX) Error: 0x%X", Res);
		else if ((Res = _wclGattClient.FindCharacteristic(_buttplugService, _definition->rxCharacteristicId, _rxCharac)) != WCL_E_SUCCESS)
			debug("FindCharacteristic (RX) Error: 0x%X", Res);
		else if ((Res = _wclGattClient.Subscribe(_rxCharac)) != WCL_E_SUCCESS)
			debug("Subscribe failed Error 0x%X!\n", Res);
		else if ((Res = _wclGattClient.WriteClientConfiguration(_rxCharac, true, goNone)) != WCL_E_SUCCESS)
			debug("WriteClientConfiguration->SubscribeForNotifications failed 0x%X\n", Res);
		else if (!issueCommand("DeviceType;"))
			debug("Unable to query device type\n");
		else
			return; // Success
	} else if (Error == WCL_E_BLUETOOTH_LE_DEVICE_NOT_FOUND)
		debug("BTLE device not found.\n");
	else
		debug("Connection failed with error 0x%X\n", Error);

	disconnect();
}

void HushDevice::wclGattClientDisconnect(void* Sender, const int Reason) {
	debug("Buttplug disconnected, reason = 0x%X\n", Reason);
	_status = BP_DISCONNECTED;
	System::SetEvent(_connectedEvent);
}

bool HushDevice::issueCommand(const char* commandString) {
	if (System::WaitSema(&_runningCommand, 1000) != SEMA_TIMEOUT) {
		const int Res = _wclGattClient.WriteCharacteristicValue(_txCharac, (const unsigned char*)commandString, (unsigned int)strlen(commandString), plNone, wkWithoutResponse);
		if (Res == WCL_E_SUCCESS)
			return true;
		debug("WriteCharacteristicValue error 0x%X\n", Res);
	} else
		debug("Timeout waiting for previous command to complete\n");

	disconnect();
	System::SignalSema(&_runningCommand);
	return false;
}

void HushDevice::wclGattClientCharacteristicChanged(void* Sender, const unsigned short Handle,
	const unsigned char* const Value, const unsigned long Length) {

	System::SignalSema(&_runningCommand);

	std::string response((const char*)Value, Length);
	if (isalpha(response[0]) && (response[1] == ':')) {
		if (response[0] != 'Z')
			log("WARN: This does not look like a Hush device\n");
		_deviceId = response;
		issueCommand("Battery;");
	} else if (isdigit(response[0]) && (Length <= 4)) {
		_batteryLevel = std::stoi(response);
		if (_status == BP_CONNECTING) {
			_status = BP_CONNECTED;
			System::SetEvent(_connectedEvent);
		}
	} else if (response.compare("POWEROFF;") == 0)
		disconnect();
	else if (response.compare("OK;") != 0)
		debug("Unknown BP response! (Length = %d): %s\n", Length, response.c_str());
}

void HushDevice::setVibrate(unsigned char effectiveVibrationPercent) {
	if (_status != BP_CONNECTED)
		return;
	if (_vibration != effectiveVibrationPercent) {
		_vibration = effectiveVibrationPercent;
		char commandBuffer[16];
		int vibrateSetting = std::clamp((effectiveVibrationPercent * MAX_VIBRATION_SETTING + 99) / 100, 0, MAX_VIBRATION_SETTING);
		sprintf(commandBuffer, "Vibrate:%d;", vibrateSetting);
		issueCommand(commandBuffer);
	}
}

bool HushDevice::readBatteryLevel() {
	if (_status != BP_CONNECTED)
		return false;
	return issueCommand("Battery;");
}

int HushDevice::getBatteryLevel() const {
	if (_status != BP_CONNECTED)
		return 0;
	return _batteryLevel;
}

const std::string& HushDevice::getDeviceId() const {
	return _deviceId;
}

const std::string& HushDevice::getDeviceName() const {
	return _deviceName;
}

bool HushDevice::isConnected() {
	if (_status == BP_DISCONNECTED)
		connect();
	return _status == BP_CONNECTED;
}

const int HushDevice::CONNECT_RETRY_MS = 2500;

const int HushDevice::MAX_VIBRATION_SETTING = 20;

const wclGattUuid HushDevice::GENERIC_ACCESS_SERVICE_UUID = { true, 0x1800, { 0, 0, 0, { 0, 0, 0, 0, 0, 0, 0, 0 } } };
const wclGattUuid HushDevice::DEVICE_NAME_CHARAC_UUID = { true, 0x2A00, { 0, 0, 0, { 0, 0, 0, 0, 0, 0, 0, 0 } } };

const ButtplugDeviceDefinition HushDevice::HUSH_DEVICE[] = {
	{{ false, 0, { 0x0000fff0, 0x0000, 0x1000, { 0x80, 0x00, 0x00, 0x80, 0x5f, 0x9b, 0x34, 0xfb }}},
	  { false, 0, { 0x0000fff2, 0x0000, 0x1000, { 0x80, 0x00, 0x00, 0x80, 0x5f, 0x9b, 0x34, 0xfb }}},
	  { false, 0, { 0x0000fff1, 0x0000, 0x1000, { 0x80, 0x00, 0x00, 0x80, 0x5f, 0x9b, 0x34, 0xfb }}}},
	{{ false, 0, { 0x6e400001, 0xb5a3, 0xf393, { 0xe0, 0xa9, 0xe5, 0x0e, 0x24, 0xdc, 0xca, 0x9e }}},
	  { false, 0, { 0x6e400002, 0xb5a3, 0xf393, { 0xe0, 0xa9, 0xe5, 0x0e, 0x24, 0xdc, 0xca, 0x9e }}},
	  { false, 0, { 0x6e400003, 0xb5a3, 0xf393, { 0xe0, 0xa9, 0xe5, 0x0e, 0x24, 0xdc, 0xca, 0x9e }}}},
	{{ false, 0, { 0x50300001, 0x0024, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x50300002, 0x0024, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x50300003, 0x0024, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x57300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x57300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x57300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x5a300001, 0x0024, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x5a300002, 0x0024, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x5a300003, 0x0024, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x50300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x50300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x50300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x53300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x53300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x53300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x5a300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x5a300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x5a300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x4f300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4f300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4f300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x42300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x42300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x42300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x43300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x43300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x43300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x4c300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4c300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4c300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x4c410001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4c410002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4c410003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x56300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x56300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x56300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x58300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x58300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x58300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x52300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x52300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x52300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x46300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x46300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x46300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x50300011, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x50300012, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x50300013, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x4a300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4a300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4a300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x45440001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45440002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45440003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x45420001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45420002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45420003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x54300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x54300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x54300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x45490001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45490002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45490003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x4e300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4e300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4e300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x45410001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45410002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45410003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x51300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x51300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x51300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x45460001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45460002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x45460003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x454c0001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x454c0002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x454c0003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x55300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x55300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x55300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x53440001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x53440002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x53440003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x48300001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x48300002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x48300003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x46530001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x46530002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x46530003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x42410001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x42410002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x42410003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x43410001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x43410002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x43410003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x4f430001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4f430002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x4f430003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
	{{ false, 0, { 0x455a0001, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x455a0002, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}},
	  { false, 0, { 0x455a0003, 0x0023, 0x4bd4, { 0xbb, 0xd5, 0xa6, 0x92, 0x0e, 0x4c, 0x56, 0x53 }}}},
};

const int HushDevice::NUM_HUSH_DEVICES = sizeof(HUSH_DEVICE) / sizeof(HUSH_DEVICE[0]);

